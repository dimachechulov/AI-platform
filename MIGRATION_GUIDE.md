# Руководство по инициализации базы данных

Проект больше не использует Alembic/SQLAlchemy. Структура базы данных описана
в чистом SQL (`app/db/schema.py`), а скрипт `app/db/init_database.py`
применяет ее при запуске.

## Автоматическая инициализация

При запуске через `docker-compose up` выполняются шаги:

1. **Ожидание Postgres** – скрипт ждет доступности сервера.
2. **Создание БД** – если целевая база еще не создана, она появляется
   автоматически.
3. **Создание расширения `pgvector`** – необходимо для хранения эмбеддингов.
4. **Применение схемы** – все DDL-операторы из `schema.py` выполняются
   последовательно.

## Ручной запуск

Чтобы переинициализировать базу данных вручную:

```bash
docker-compose exec app python -m app.db.init_database
```

Команда безопасна для повторного запуска — все `CREATE TABLE … IF NOT EXISTS`
и `CREATE INDEX … IF NOT EXISTS`.

## Изменение структуры

1. Отредактируйте `app/db/schema.py`, добавив или изменив нужные DDL-операторы.
2. Перезапустите `python -m app.db.init_database`, чтобы применить изменения.
3. При необходимости мигрируйте данные вручную (так как автоматического
   версионирования больше нет).

## Таблицы

- `users`, `workspaces`, `bots` — сущности ядра платформы.
- `documents`, `document_chunks`, `document_chunk_embeddings` — хранение файлов
  и их векторных представлений.
- `api_tools` — конфигурации внешних API.
- `chat_sessions`, `chat_messages` — история общения с ботом.

## Сброс базы данных

```bash
docker-compose down -v
docker-compose up -d
```

Команда удалит volume Postgres и развернет схему заново.

